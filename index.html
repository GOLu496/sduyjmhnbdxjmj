<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Style Call</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #111b21;
            --header-color: #202c33;
            --accent-color: #00a884;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: Helvetica, Arial, sans-serif;
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            user-select: none;
        }

        /* HEADER & ID CARD */
        .header {
            background-color: var(--header-color); padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); font-weight: bold; font-size: 20px; color: var(--text-secondary);
        }
        .id-card {
            background: var(--header-color); margin: 20px; padding: 20px;
            border-radius: 15px; text-align: center; border: 1px solid #333;
        }
        .my-id-display {
            font-size: 32px; font-weight: bold; color: var(--accent-color);
            letter-spacing: 2px; margin: 10px 0; cursor: pointer;
        }

        /* RECENT CALLS LIST */
        #recent-list { flex: 1; overflow-y: auto; }
        .call-item {
            display: flex; align-items: center; padding: 15px;
            cursor: pointer; border-bottom: 1px solid #202c33;
        }
        .call-item:active { background-color: #202c33; }
        .avatar {
            width: 50px; height: 50px; background-color: #6b7c85;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            margin-right: 15px;
        }
        .info { flex: 1; }
        .name { font-size: 17px; font-weight: 500; margin-bottom: 4px; }
        .time { font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; gap: 5px; }
        .call-icon { color: var(--accent-color); font-size: 24px; }

        /* MODAL & FAB */
        .fab {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background-color: var(--accent-color); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); cursor: pointer; z-index: 20;
        }
        .fab i { color: white; font-size: 28px; }
        #dial-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center;
        }
        .modal-box { background: var(--header-color); padding: 25px; width: 80%; border-radius: 15px; text-align: center; }
        input { width: 100%; padding: 12px; background: #2a3942; border: none; color: white; border-radius: 8px; margin: 20px 0; font-size: 18px; text-align: center; box-sizing: border-box; }
        .modal-btn { padding: 10px 25px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; margin: 5px; }
        .btn-call { background: var(--accent-color); color: white; }
        .btn-cancel { background: transparent; color: var(--text-secondary); }

        /* VIDEO & INCOMING SCREENS */
        #video-screen, #incoming-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 200; display: none;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; bottom: 120px; right: 20px; width: 100px; height: 150px; background: #333; border-radius: 10px; border: 2px solid white; transform: scaleX(-1); }
        .controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 30px; }
        .ctrl-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 28px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: white; }
        .btn-end { background: #f44336; }
        
        #incoming-screen { background: rgba(11, 20, 26, 0.95); flex-direction: column; align-items: center; justify-content: center; }
        .avatar-large { width: 100px; height: 100px; background: var(--accent-color); border-radius: 50%; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; font-size: 40px; color: white; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>
<body>
    <div class="header">WhatsApp Call</div>
    <div class="id-card">
        <div style="font-size: 14px; color: #aaa;">YOUR ID</div>
        <div class="my-id-display" id="display-my-id" onclick="copyID()">...</div>
        <div style="font-size: 12px; color: #777;">Tap to copy & share</div>
    </div>

    <div id="recent-list">
        <div style="text-align: center; padding: 50px; color: #8696a0;">Tap + to start a call.</div>
    </div>

    <div class="fab" onclick="openDialer()"><i class="material-icons">add_call</i></div>

    <div id="dial-modal">
        <div class="modal-box">
            <h3>New Video Call</h3>
            <input type="number" id="input-partner-id" placeholder="Enter 4-digit ID">
            <div><button class="modal-btn btn-cancel" onclick="closeDialer()">Cancel</button><button class="modal-btn btn-call" onclick="dialFromInput()">Call</button></div>
        </div>
    </div>

    <div id="incoming-screen">
        <div class="avatar-large"><i class="material-icons">person</i></div>
        <h2 id="caller-id-disp">Unknown</h2><p style="color: #8696a0;">WhatsApp Video Call</p>
        <div style="display: flex; gap: 50px; margin-top: 50px;">
            <button class="ctrl-btn btn-end" onclick="rejectCall()"><i class="material-icons">call_end</i></button>
            <button class="ctrl-btn" style="background: #00a884;" onclick="acceptCall()"><i class="material-icons">videocam</i></button>
        </div>
    </div>

    <div id="video-screen">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="controls"><button class="ctrl-btn btn-end" onclick="endCall()"><i class="material-icons">call_end</i></button></div>
    </div>

    <script>
        // 1. SETUP & ID
        let myID = localStorage.getItem('clean_id');
        if (!myID || isNaN(myID)) {
            myID = Math.floor(1000 + Math.random() * 9000).toString();
            localStorage.setItem('clean_id', myID);
        }
        const urlParams = new URLSearchParams(window.location.search);
        const finalID = urlParams.get('id') || myID;
        document.getElementById('display-my-id').innerText = finalID;

        const peer = new Peer(finalID, { config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] } });
        let currentCall = null, localStream = null;
        let callHistory = JSON.parse(localStorage.getItem('wa_call_history')) || [];

        // 2. PEER EVENTS
        peer.on('open', (id) => { console.log("My ID: " + id); renderHistory(); });
        peer.on('call', (call) => {
            currentCall = call;
            document.getElementById('incoming-screen').style.display = 'flex';
            document.getElementById('caller-id-disp').innerText = call.peer;
            // Optional: window.location.href = "kodular:INCOMING:" + call.peer;
        });
        peer.on('error', (err) => alert("Error: " + err.type));

        // 3. CALL FUNCTIONS
        function openDialer() { document.getElementById('dial-modal').style.display = 'flex'; }
        function closeDialer() { document.getElementById('dial-modal').style.display = 'none'; }
        function dialFromInput() { const id = document.getElementById('input-partner-id').value; if(id) { closeDialer(); startCall(id); }}
        function copyID() { navigator.clipboard.writeText(finalID).then(() => alert("ID Copied!")); }

        function startCall(partnerID) {
            if(partnerID === finalID) return alert("Cannot call yourself");
            document.getElementById('video-screen').style.display = 'block';
            addToHistory(partnerID, 'outgoing');
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
                localStream = stream; document.getElementById('local-video').srcObject = stream;
                const call = peer.call(partnerID, stream); currentCall = call;
                call.on('stream', (remoteStream) => { document.getElementById('remote-video').srcObject = remoteStream; });
                call.on('close', endCall); call.on('error', () => { alert("Call failed"); endCall(); });
            }).catch(err => alert("Camera Permission Required"));
        }

        function acceptCall() {
            document.getElementById('incoming-screen').style.display = 'none';
            document.getElementById('video-screen').style.display = 'block';
            addToHistory(currentCall.peer, 'incoming');
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
                localStream = stream; document.getElementById('local-video').srcObject = stream;
                currentCall.answer(stream);
                currentCall.on('stream', (remoteStream) => { document.getElementById('remote-video').srcObject = remoteStream; });
                currentCall.on('close', endCall);
            });
        }
        function rejectCall() { if(currentCall) currentCall.close(); document.getElementById('incoming-screen').style.display = 'none'; }
        function endCall() { if(currentCall) currentCall.close(); if(localStream) localStream.getTracks().forEach(t => t.stop()); document.getElementById('video-screen').style.display = 'none'; location.reload(); }

        // 4. HISTORY LOGIC
        function addToHistory(id, type) {
            callHistory = callHistory.filter(item => item.id !== id);
            callHistory.unshift({ id: id, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), type: type });
            localStorage.setItem('wa_call_history', JSON.stringify(callHistory));
            renderHistory();
        }
        function renderHistory() {
            const list = document.getElementById('recent-list');
            if(callHistory.length === 0) return;
            list.innerHTML = '';
            callHistory.forEach(item => {
                const isOutgoing = item.type === 'outgoing';
                const div = document.createElement('div'); div.className = 'call-item'; div.onclick = () => startCall(item.id);
                div.innerHTML = `<div class="avatar"><i class="material-icons" style="color:white;">person</i></div><div class="info"><div class="name">${item.id}</div><div class="time"><i class="material-icons" style="font-size:14px; color:${isOutgoing ? '#00a884' : '#f44336'}; margin-right:5px;">${isOutgoing ? 'call_made' : 'call_received'}</i>${item.time}</div></div><i class="material-icons call-icon">videocam</i>`;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
