<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Pro - Final Version</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root { --bg: #0b141a; --header: #202c33; --accent: #00a884; --text: #e9edef; --gray: #8696a0; --danger: #f44336; --msg-in: #202c33; --msg-out: #005c4b; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .form-box { width: 100%; max-width: 380px; text-align: center; background: var(--header); padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
       
        .profile-upload { position: relative; width: 110px; height: 110px; margin: 0 auto 20px; }
        .preview-img { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 3px solid var(--accent); background: #2a3942; }
        .upload-badge { position: absolute; bottom: 5px; right: 5px; background: var(--accent); border-radius: 50%; padding: 6px; cursor: pointer; display: flex; }

        input { width: 100%; padding: 12px; background: #2a3942; border: 1px solid #3b4a54; color: white; border-radius: 8px; margin: 8px 0; box-sizing: border-box; outline: none; }
        .checkbox-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 12px; font-size: 13px; text-align: left; cursor: pointer; }

       
        .header { background: var(--header); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        
        
        #chat-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 500; display: none; flex-direction: column; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-size: contain; }
        .msg { padding: 8px 12px; border-radius: 8px; max-width: 75%; font-size: 14px; }
        .sent { align-self: flex-end; background: var(--msg-out); }
        .received { align-self: flex-start; background: var(--msg-in); }
        .chat-input { background: var(--header); padding: 10px; display: flex; align-items: center; gap: 10px; }

        
        #video-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1500; display: none; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 100px; height: 150px; border-radius: 10px; border: 2px solid #fff; transform: scaleX(-1); object-fit: cover; }

        .btn-green { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 30px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-green:disabled { opacity: 0.5; cursor: not-allowed; }
        .fab { position: fixed; bottom: 25px; right: 25px; background: var(--accent); width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer; z-index: 200; }
    </style>
</head>
<body>

 <div id="setup-overlay" class="overlay" style="display: flex;">
    <div class="form-box">
        <div class="profile-upload">
            <img id="reg-preview" class="preview-img" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            <label for="reg-img-input" class="upload-badge"><i class="material-icons" style="font-size: 20px;">camera_alt</i></label>
            <input type="file" id="reg-img-input" accept="image/*" hidden onchange="processImage(this, 'reg-preview')">
        </div>
        <h2>Register</h2>
        
        <input type="number" id="setup-id" placeholder="Mobile Number (UserID)" oninput="if(this.value.length > 10) this.value = this.value.slice(0, 10);" onkeyup="validateReg()">
        
        <input type="text" id="setup-name" placeholder="Full Name" onkeyup="validateReg()">
        
        <div style="margin: 15px 0;">
            <label class="checkbox-row">
                <input type="checkbox" id="check-1" onchange="validateReg()">
                <span>I agree to the <span style="color:var(--accent); text-decoration:underline; cursor:pointer;" onclick="showLegalModal()">Terms & Conditions</span>.</span>
            </label>
            <label class="checkbox-row">
                <input type="checkbox" id="check-2" onchange="validateReg()">
                <span>I confirm that I am responsible for any illegal activity.</span>
            </label>
        </div>
        
        <button id="reg-btn" class="btn-green" disabled onclick="saveProfile(true)">START CONNECTING</button>
    </div>
</div>

<div id="legal-modal" class="overlay" style="background: rgba(0,0,0,0.95); z-index: 4000;">
    <div class="form-box" style="text-align: left; max-height: 80vh; overflow-y: auto;">
        <h3 style="color:var(--accent);">Terms & Conditions</h3>
        <p style="font-size: 13px; line-height: 1.6; color: var(--text);">
            <strong>1. Scope of Service:</strong> This application is a Peer-to-Peer (P2P) communication tool. No messages or video calls are stored on any central server.<br><br>
            <strong>2. User Identity:</strong> Your mobile number is your unique ID. Your profile photo and name will be visible to users you connect with.<br><br>
            <strong style="color:var(--danger);">3. ILLEGAL ACTIVITY WARNING:</strong> ANY FORM OF ILLEGAL ACTIVITY, INCLUDING BUT NOT LIMITED TO HARASSMENT, FRAUD, SHARING OF EXPLICIT CONTENT, OR THREATS, IS STRICTLY PROHIBITED.<br><br>
            <strong>4. USER RESPONSIBILITY:</strong> You explicitly agree that you are solely responsible for all content, messages, and calls made through your ID. The developer/owner of this platform will NOT be held liable for any misuse, legal disputes, or damages resulting from your actions.<br><br>
            <strong>5. Data Privacy:</strong> Since the connection is direct between devices, you are responsible for maintaining the privacy of your own ID.
        </p>
        <button class="btn-green" onclick="hideLegalModal()">I HAVE READ & UNDERSTOOD</button>
    </div>
</div>

    <div id="settings-overlay" class="overlay">
        <div class="form-box">
            <h3>Update Profile</h3>
            <div class="profile-upload">
                <img id="edit-preview" class="preview-img" src="">
                <label for="edit-img-input" class="upload-badge"><i class="material-icons" style="font-size: 20px;">edit</i></label>
                <input type="file" id="edit-img-input" accept="image/*" hidden onchange="processImage(this, 'edit-preview')">
            </div>
            <input type="text" id="edit-name" placeholder="Full Name">
            <p style="color:var(--gray); font-size:12px;">Mobile ID: <b id="locked-id"></b></p>
            <button class="btn-green" onclick="saveProfile(false)">SAVE CHANGES</button>
            <button class="btn-green" style="background:transparent; color:var(--gray);" onclick="toggleOverlay('settings-overlay', false)">CANCEL</button>
            <hr style="border:0.1px solid #333; margin:15px 0;">
            <button class="btn-green" style="background:var(--danger);" onclick="logout()">LOGOUT</button>
        </div>
    </div>

    <div class="header">
        <div class="user-info">
            <img id="my-avatar-display" src="">
            <div>
                <b id="my-name-display"></b><br>
                <span id="my-id-display" style="font-size: 11px; color: var(--accent);"></span>
            </div>
        </div>
        <i class="material-icons" style="color: var(--gray); cursor: pointer;" onclick="openSettings()">settings</i>
    </div>

    <div id="history-container" style="flex:1; overflow-y:auto; padding:10px;">
        <p style="text-align:center; color:var(--gray); margin-top:50px;">No recent chats. Tap + to start.</p>
    </div>

    <div class="fab" onclick="toggleOverlay('dial-modal', true)"><i class="material-icons" style="color:white;">chat</i></div>

    <div id="chat-screen">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <i class="material-icons" onclick="closeChat()">arrow_back</i>
                <b id="chat-title">User</b>
            </div>
            <i class="material-icons" style="color:var(--accent);" onclick="startCall()">videocam</i>
        </div>
        <div id="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="msg-input" placeholder="Type a message">
            <i class="material-icons" style="color:var(--accent);" onclick="sendMsg()">send</i>
        </div>
    </div>

    <div id="video-screen">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div style="position:absolute; bottom:40px; width:100%; text-align:center;">
            <button onclick="endCall()" style="background:var(--danger); border:none; width:65px; height:65px; border-radius:50%;"><i class="material-icons" style="color:white; font-size:30px;">call_end</i></button>
        </div>
    </div>

    <div id="dial-modal" class="overlay" style="background:rgba(0,0,0,0.85);">
        <div class="form-box">
            <h3>Start Chat</h3>
            <input type="number" id="target-id" placeholder=" Enter Partner's UserID">
            <button class="btn-green" onclick="initiateChat()">OPEN CHAT</button>
            <button class="btn-green" style="background:transparent;" onclick="toggleOverlay('dial-modal', false)">CANCEL</button>
        </div>
    </div>

    <script>
        let peer, conn, currentCall, localStream;
        let myProfile = JSON.parse(localStorage.getItem('wp_pro_master_v1'));
        let currentPhoto = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        let activePartnerId = null;

        window.onload = () => {
            if (myProfile) {
                document.getElementById('setup-overlay').style.display = 'none';
                initPeer();
            }
        };

       
function showLegalModal() { document.getElementById('legal-modal').style.display = 'flex'; }
function hideLegalModal() { document.getElementById('legal-modal').style.display = 'none'; }

function validateReg() {
    const c1 = document.getElementById('check-1').checked;
    const c2 = document.getElementById('check-2').checked;
    const id = document.getElementById('setup-id').value;
    const name = document.getElementById('setup-name').value;

   
    const isIdValid = id.length === 10;

   
    const vowelMatch = name.match(/[aeiouAEIOU]/g);
    const vowelCount = vowelMatch ? vowelMatch.length : 0;
    const isNameValid = vowelCount >= 2;

    const btn = document.getElementById('reg-btn');
    if (c1 && c2 && isIdValid && isNameValid) {
        btn.disabled = false;
        btn.style.opacity = "1";
    } else {
        btn.disabled = true;
        btn.style.opacity = "0.5";
    }
}

        function processImage(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    currentPhoto = e.target.result;
                    document.getElementById(previewId).src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProfile(isFirst) {
            const id = isFirst ? document.getElementById('setup-id').value : myProfile.id;
            const name = isFirst ? document.getElementById('setup-name').value : document.getElementById('edit-name').value;
            
            myProfile = { id, name, photo: currentPhoto };
            localStorage.setItem('wp_pro_master_v1', JSON.stringify(myProfile));
            location.reload();
        }

        function initPeer() {
            document.getElementById('my-avatar-display').src = myProfile.photo;
            document.getElementById('my-name-display').innerText = myProfile.name;
            document.getElementById('my-id-display').innerText = "ID: " + myProfile.id;
            currentPhoto = myProfile.photo;

            peer = new Peer(myProfile.id);
            peer.on('connection', (c) => {
                conn = c;
                activePartnerId = c.peer;
                setupChatLogic();
                document.getElementById('chat-screen').style.display = 'flex';
            });
            peer.on('call', (call) => {
                if(confirm("Video call from " + call.peer)) {
                    currentCall = call;
                    answerCall();
                }
            });
        }

        function initiateChat() {
            const id = document.getElementById('target-id').value;
            if(!id) return;
            toggleOverlay('dial-modal', false);
            activePartnerId = id;
            document.getElementById('chat-title').innerText = id;
            document.getElementById('chat-screen').style.display = 'flex';
            conn = peer.connect(id);
            setupChatLogic();
        }

        function setupChatLogic() {
            conn.on('data', data => displayMsg(data, 'received'));
        }

        function sendMsg() {
            const val = document.getElementById('msg-input').value;
            if(!val || !conn) return;
            conn.send(val);
            displayMsg(val, 'sent');
            document.getElementById('msg-input').value = "";
        }

        function displayMsg(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            document.getElementById('chat-messages').appendChild(div);
            document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
        }

        async function startCall() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                document.getElementById('video-screen').style.display = 'block';
                document.getElementById('local-video').srcObject = localStream;
                const call = peer.call(activePartnerId, localStream);
                currentCall = call;
                call.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
            } catch(e) { alert("Camera Permission Required"); }
        }

        async function answerCall() {
            localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('video-screen').style.display = 'block';
            document.getElementById('local-video').srcObject = localStream;
            currentCall.answer(localStream);
            currentCall.on('stream', rs => document.getElementById('remote-video').srcObject = rs);
        }

        function endCall() { location.reload(); }
        function closeChat() { document.getElementById('chat-screen').style.display = 'none'; }
        function toggleOverlay(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; }
        function openSettings() {
            document.getElementById('edit-name').value = myProfile.name;
            document.getElementById('edit-preview').src = myProfile.photo;
            document.getElementById('locked-id').innerText = myProfile.id;
            toggleOverlay('settings-overlay', true);
        }
        function logout() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>